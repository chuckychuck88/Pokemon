<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pokémon Survival + Crafting (Fixed)</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:#000;}
  canvas{width:100vw;height:100vh;display:block;image-rendering:pixelated;cursor:crosshair;}
  #craftingUI{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    background:#222;border:3px solid #fff;padding:20px;border-radius:10px;
    display:none;color:white;font-family:monospace;text-align:center;
  }
  .craft-item{
    margin:10px;padding:10px;border:2px solid #888;background:#333;cursor:pointer;
  }
  .craft-item:hover{background:#444;}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="craftingUI">
  <h2>Crafting</h2>
  <div id="craftList"></div>
  <p style="color:gray;">Press [C] to close</p>
</div>

<script>
// ====== Canvas Setup ======
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d",{alpha:true});
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
resize();addEventListener("resize",resize);

// ====== Assets ======
const playerImg=new Image();playerImg.src="assets/player.png";
const stoneImg=new Image();stoneImg.src="assets/stone.png";
const iconWood=new Image();iconWood.src="assets/item_wood.png";
const iconStone=new Image();iconStone.src="assets/item_stone.png";
const iconAxe=new Image();iconAxe.src="assets/item_axe.png";
const iconPickaxe=new Image();iconPickaxe.src="assets/item_pickaxe.png";

// ====== Game Data ======
const player={x:0,y:0,speed:4};
let inventory={wood:0,stone:0,axe:false,pickaxe:false};
const trees=[],stones=[];

// ====== Background Grass ======
const grass=document.createElement("canvas");
grass.width=64;grass.height=64;
const gctx=grass.getContext("2d");
gctx.fillStyle="#3aa63f";gctx.fillRect(0,0,64,64);
gctx.fillStyle="#2e8b34";
for(let i=0;i<80;i++)gctx.fillRect(Math.random()*64,Math.random()*64,3,3);
const pattern=ctx.createPattern(grass,"repeat");

// ====== Generate World Objects ======
for(let i=0;i<40;i++)trees.push({x:Math.random()*4000-2000,y:Math.random()*4000-2000,size:64,health:3,breaking:false});
for(let i=0;i<25;i++)stones.push({x:Math.random()*4000-2000,y:Math.random()*4000-2000,size:64,health:3,breaking:false});

// ====== Controls ======
const keys={};
onkeydown=e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key.toLowerCase()==='c') toggleCrafting();
};
onkeyup=e=>keys[e.key.toLowerCase()]=false;
canvas.addEventListener("click",handleClick);

// ====== Crafting System ======
const craftingUI=document.getElementById("craftingUI");
const craftList=document.getElementById("craftList");
let craftingOpen=false;
const recipes=[
  {name:"Axe",req:{wood:3,stone:2},item:"axe"},
  {name:"Pickaxe",req:{wood:2,stone:3},item:"pickaxe"}
];

function toggleCrafting(){
  craftingOpen=!craftingOpen;
  craftingUI.style.display=craftingOpen?"block":"none";
  if(craftingOpen) renderCrafting();
}

function renderCrafting(){
  craftList.innerHTML="";
  recipes.forEach(r=>{
    const div=document.createElement("div");
    div.className="craft-item";
    div.innerHTML=`<b>${r.name}</b><br>Wood: ${r.req.wood} | Stone: ${r.req.stone}`;
    div.onclick=()=>craftItem(r);
    craftList.appendChild(div);
  });
}

function craftItem(recipe){
  if(inventory[recipe.item]){
    popup(`${recipe.name} already crafted!`,player.x,player.y,"#ccc");
    return;
  }
  const canCraft=inventory.wood>=recipe.req.wood && inventory.stone>=recipe.req.stone;
  if(canCraft){
    inventory.wood-=recipe.req.wood;
    inventory.stone-=recipe.req.stone;
    inventory[recipe.item]=true;
    popup(`Crafted ${recipe.name}!`,player.x,player.y,"#ffd700");
  }else{
    popup("Not enough materials!",player.x,player.y,"#ff4040");
  }
}

// ====== Breaking Trees & Stones ======
function handleClick(e){
  if(craftingOpen) return; // Can't break while crafting
  const mx=e.offsetX-canvas.width/2+player.x;
  const my=e.offsetY-canvas.height/2+player.y;
  let target=null;
  [...trees,...stones].forEach(obj=>{
    const dist=Math.hypot(obj.x-mx,obj.y-my);
    if(dist<60 && !target) target=obj;
  });

  if(target){
    target.breaking=true;
    let delay=250;
    if(trees.includes(target)&&inventory.axe) delay=120;
    if(stones.includes(target)&&inventory.pickaxe) delay=120;

    setTimeout(()=>{
      target.health--;
      if(target.health<=0){
        if(trees.includes(target)){
          trees.splice(trees.indexOf(target),1);
          const amt=Math.floor(Math.random()*2)+2;
          inventory.wood+=amt;
          popup("+ "+amt+" wood",target.x,target.y,"#d0a050");
        }else if(stones.includes(target)){
          stones.splice(stones.indexOf(target),1);
          const amt=Math.floor(Math.random()*2)+2;
          inventory.stone+=amt;
          popup("+ "+amt+" stone",target.x,target.y,"#c0c0c0");
        }
      }
      target.breaking=false;
    },delay);
  }
}

// ====== Pop-up Text ======
const popups=[];
function popup(txt,x,y,color){ popups.push({txt,x,y,color,life:60}); }

// ====== Draw Tree ======
function drawTree(g,x,y,size,breaking){
  g.save();
  if(breaking) g.translate(x+Math.random()*4-2,y+Math.random()*4-2);
  else g.translate(x,y);
  g.fillStyle="#5c3b1e";g.fillRect(size/2-5,size-18,10,18);
  for(let i=0;i<3;i++){
    const baseY=size/2-i*12;
    const shade=i===0?"#4cd155":i===1?"#38b044":"#2a8b34";
    g.fillStyle=shade;
    g.beginPath();
    g.moveTo(0,baseY);
    g.lineTo(size,baseY);
    g.lineTo(size/2,baseY-14);
    g.closePath();g.fill();
  }
  g.restore();
}

// ====== Game Loop ======
function loop(){
  // ✅ You can always move, even after crafting
  let dx=0,dy=0;
  if(keys["w"]||keys["arrowup"])dy-=player.speed;
  if(keys["s"]||keys["arrowdown"])dy+=player.speed;
  if(keys["a"]||keys["arrowleft"])dx-=player.speed;
  if(keys["d"]||keys["arrowright"])dx+=player.speed;
  player.x+=dx;player.y+=dy;

  ctx.fillStyle=pattern;
  ctx.save();
  ctx.translate(canvas.width/2-player.x,canvas.height/2-player.y);
  ctx.fillRect(player.x-canvas.width,player.y-canvas.height,canvas.width*2,canvas.height*2);
  ctx.imageSmoothingEnabled=false;

  for(const t of trees) drawTree(ctx,t.x-32,t.y-64,t.size,t.breaking);
  for(const s of stones){
    ctx.save();
    if(s.breaking) ctx.translate(s.x+Math.random()*4-2,s.y+Math.random()*4-2);
    else ctx.translate(s.x,s.y);
    if(stoneImg.complete) ctx.drawImage(stoneImg,-s.size/2,-s.size/2,s.size,s.size);
    ctx.restore();
  }

  // Player
  if(playerImg.complete) ctx.drawImage(playerImg,player.x-32,player.y-32,64,64);
  else{ ctx.fillStyle="yellow";ctx.fillRect(player.x-24,player.y-24,48,48); }

  // Popups
  for(let i=popups.length-1;i>=0;i--){
    const p=popups[i];
    ctx.fillStyle=p.color;
    ctx.font="20px monospace";
    ctx.fillText(p.txt,p.x,p.y-p.life/2);
    p.life--; if(p.life<=0)popups.splice(i,1);
  }

  ctx.restore();
  drawSimpleInventory();
  requestAnimationFrame(loop);
}
loop();

// ====== Draw Inventory ======
function drawSimpleInventory(){
  const baseX=20, baseY=20;
  ctx.save();
  ctx.globalAlpha=1;
  if(iconWood.complete) ctx.drawImage(iconWood, baseX, baseY, 48, 48);
  ctx.fillStyle="#fff";ctx.font="22px monospace";
  ctx.fillText(inventory.wood, baseX+60, baseY+30);
  if(iconStone.complete) ctx.drawImage(iconStone, baseX+120, baseY, 48, 48);
  ctx.fillText(inventory.stone, baseX+180, baseY+30);
  let offset=240;
  if(inventory.axe){ if(iconAxe.complete) ctx.drawImage(iconAxe, baseX+offset, baseY, 48, 48); offset+=60; }
  if(inventory.pickaxe){ if(iconPickaxe.complete) ctx.drawImage(iconPickaxe, baseX+offset, baseY, 48, 48); offset+=60; }
  ctx.restore();
}
</script>
</body>
</html>
